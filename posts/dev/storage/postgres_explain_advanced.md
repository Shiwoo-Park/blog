---
layout: post
title: "Postgres SQL ì‹¤í–‰ê³„íš ë¶„ì„ - 3ë¶€: ê³ ê¸‰ ì£¼ì œ"
date: 2025-08-23
categories: [database, postgresql, optimization]
---

> **ì‹œë¦¬ì¦ˆ ëª©ì°¨**
> - [1ë¶€: ê¸°ë³¸ê¸°](/blog/posts/dev/storage/postgres_explain_basics/)
> - [2ë¶€: ì‹¤ì „ ìµœì í™”](/blog/posts/dev/storage/postgres_explain_optimization/)
> - **3ë¶€: ê³ ê¸‰ ì£¼ì œ** (í˜„ìž¬ ë¬¸ì„œ)

> **ì°¸ê³ **: ì˜ˆì œ ìŠ¤í‚¤ë§ˆëŠ” [1ë¶€](/blog/posts/dev/storage/postgres_explain_basics/#ì˜ˆì œ-ìŠ¤í‚¤ë§ˆ-ê³µí†µ)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

## 1) CBO(Cost Based Optimizer)ê°€ Costë¥¼ ê³„ì‚°í•˜ëŠ” ê¸°ì¤€

### ðŸ”Ž CBO í•µì‹¬ ê°œë…

PostgresëŠ” ì¿¼ë¦¬ ì‹¤í–‰ ì „ì—:
1. ì—¬ëŸ¬ **ì‹¤í–‰ê³„íš í›„ë³´** ìƒì„±
2. ê° í”Œëžœì˜ **ë¹„ìš©(Cost) ê³„ì‚°**
3. **ê°€ìž¥ ì €ë ´í•œ í”Œëžœ** ì„ íƒ

âš ï¸ **ì¤‘ìš”**: CostëŠ” ì ˆëŒ€ ì‹œê°„ì´ ì•„ë‹˜. ìƒëŒ€ ë¹„êµìš©. "í”Œëžœ Aê°€ Bë³´ë‹¤ ëª‡ ë°° ë¹ ë¥´ë‹¤" ì •ë„ë¡œë§Œ ì‚¬ìš©.

### 1-1. Cost íŒë‹¨ ê¸°ì¤€

#### (1) í†µê³„ ì •ë³´ (Statistics)

**ì—­í• **
- `ANALYZE`ë¡œ ìˆ˜ì§‘í•œ í…Œì´ë¸”/ì»¬ëŸ¼ í†µê³„
- í–‰ ê°œìˆ˜, ë°ì´í„° ë¶„í¬, null ë¹„ìœ¨, ìƒê´€ê´€ê³„ ë“±ì„ ì¶”ì •

**ë¬¸ì œ**
- í†µê³„ê°€ ì˜¤ëž˜ë˜ë©´ â†’ ìž˜ëª»ëœ í–‰ ìˆ˜ ì¶”ì • â†’ ìž˜ëª»ëœ ì‹¤í–‰ê³„íš ì„ íƒ

**ì‹¤ë¬´ íŒ**
- ëŒ€ìš©ëŸ‰ insert/update í›„ì—ëŠ” ìˆ˜ë™ìœ¼ë¡œ `ANALYZE` ì‹¤í–‰
- autovacuumë§Œ ë¯¿ì§€ ë§ ê²ƒ

#### (2) í”Œëž˜ë„ˆ ë¹„ìš© íŒŒë¼ë¯¸í„° (GUC ì„¤ì •)

Postgresê°€ CPUì™€ I/O ë¹„ìš©ì„ ê³„ì‚°í•˜ëŠ” ê¸°ì¤€ê°’:

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ì„¤ëª… | ì‹¤ë¬´ íŒ |
|---------|------|------|---------|
| `seq_page_cost` | 1.0 | ìˆœì°¨ íŽ˜ì´ì§€ ì½ê¸° ë¹„ìš© | ë³´í†µ ë³€ê²½ ì•ˆ í•¨ |
| `random_page_cost` | 4.0 | ëžœë¤ íŽ˜ì´ì§€ ì½ê¸° ë¹„ìš© | **SSDë©´ 1.1~1.5ë¡œ ë‚®ì¶¤** |
| `cpu_tuple_cost` | 0.01 | íŠœí”Œ ì²˜ë¦¬ ë¹„ìš© | ë³´í†µ ë³€ê²½ ì•ˆ í•¨ |
| `cpu_index_tuple_cost` | 0.005 | ì¸ë±ìŠ¤ íŠœí”Œ ì²˜ë¦¬ ë¹„ìš© | ë³´í†µ ë³€ê²½ ì•ˆ í•¨ |
| `effective_cache_size` | 4GB | OS ìºì‹œ ë©”ëª¨ë¦¬ ì¶”ì • | **RAMì˜ 50~75%ë¡œ ì„¤ì •** |

**ì‹¤ë¬´ íŒ**
- SSD í™˜ê²½: `random_page_cost = 1.1~1.5` (ì¸ë±ìŠ¤ ìŠ¤ìº”ì„ ë” ì„ í˜¸)
- `effective_cache_size`: ì‹¤ì œ RAMì˜ 50~75% (ì»¤ì•¼ ì¸ë±ìŠ¤ í”Œëžœ ì„ í˜¸)

#### (3) í–‰ ê°œìˆ˜ ì¶”ì • (Cardinality)

**ê³„ì‚°ì‹**
- ë‹¨ì¼ ì¡°ê±´: `ì¡°ê±´ ì„ íƒë„ Ã— ì´ í–‰ ìˆ˜ = ì˜ˆìƒ í–‰ ìˆ˜`
- ì¡°ì¸: `(ì™¸ë¶€ í–‰ ìˆ˜ Ã— ë‚´ë¶€ í–‰ ìˆ˜) Ã— ì„ íƒë„`

**ë¬¸ì œ**
- ì¶”ì •ì´ í‹€ë¦¬ë©´ â†’ ìž˜ëª»ëœ ì¡°ì¸ ë°©ë²• ì„ íƒ (ì˜ˆ: í•´ì‹œ ì¡°ì¸ ëŒ€ì‹  ì¤‘ì²© ë£¨í”„)

**ì‹¤ë¬´ íŒ**
- `EXPLAIN (ANALYZE)`ë¡œ ì˜ˆìƒ vs ì‹¤ì œ í–‰ ìˆ˜ ë¹„êµ
- ì˜¤ì°¨ê°€ í¬ë©´ â†’ `ANALYZE` ë˜ëŠ” `CREATE STATISTICS` ì‹¤í–‰

### 1-2. Cost ê³„ì‚° ê³¼ì •

ê° í”Œëžœ ë…¸ë“œë³„ë¡œ ë‹¤ìŒì„ í•©ì‚°:

```
(ì½ì„ íŽ˜ì´ì§€ ìˆ˜ Ã— íŽ˜ì´ì§€ ë¹„ìš©)
+ (ì²˜ë¦¬í•  íŠœí”Œ ìˆ˜ Ã— CPU ë¹„ìš©)
+ (ì •ë ¬/í•´ì‹œ/ë³‘ë ¬ ë“± ì¶”ê°€ ë¹„ìš©)
= Total Cost
```

**ê°€ìž¥ ë‚®ì€ Total Costë¥¼ ê°€ì§„ í”Œëžœ ì„ íƒ**


### 1-3. ì‹¤ë¬´ ì ìš© ì²´í¬ë¦¬ìŠ¤íŠ¸ âœ…

1. **í†µê³„ ìµœì‹ í™”**
   - ëŒ€ê·œëª¨ DML í›„ `ANALYZE` ì‹¤í–‰
   - ì¿¼ë¦¬ ì„±ëŠ¥ ê¸‰ë³€ ë°©ì§€

2. **í™˜ê²½ ë°˜ì˜í•œ ë¹„ìš© ì¡°ì •**
   - SSD: `random_page_cost = 1.1~1.5`
   - `effective_cache_size`: ì‹¤ì œ RAMì˜ 50~75%

3. **ì‹¤í–‰ê³„íš ê²€ì¦ ë£¨í‹´**
   - `EXPLAIN (ANALYZE, BUFFERS)`ë¡œ ì˜ˆìƒ vs ì‹¤ì œ rows ë¹„êµ
   - ì˜¤ì°¨ í¬ë©´ â†’ `CREATE STATISTICS` ê³ ë ¤ (ë‹¤ì¤‘ ì»¬ëŸ¼ ìƒê´€ê´€ê³„ ë“±)

4. **Prepared Statement ì£¼ì˜**
   - ë°˜ë³µ ì¿¼ë¦¬ëŠ” `PREPARE`ë¡œ ì„±ëŠ¥ í–¥ìƒ
   - ë‹¨, ì¡°ê±´ ê°’ì— ë”°ë¼ rows íŽ¸ì°¨ê°€ í¬ë©´ â†’ `plan_cache_mode=force_custom_plan` ê³ ë ¤

## ðŸ”‘ CBO ìš”ì•½

**CBOëŠ” ë‹¤ìŒ 3ê°€ì§€ë¥¼ ë°”íƒ•ìœ¼ë¡œ Cost ê³„ì‚°:**
1. **í†µê³„ ì •ë³´**: í–‰ ìˆ˜, ë¶„í¬, ìƒê´€ê´€ê³„
2. **ë¹„ìš© íŒŒë¼ë¯¸í„°**: I/O, CPU ë¹„ìš© ì„¤ì •ê°’
3. **ì„ íƒë„**: ì¡°ê±´ì— ë§žëŠ” í–‰ ë¹„ìœ¨

**ì‹¤ë¬´ í•„ìˆ˜ ì„¤ì •:**
- SSD í™˜ê²½: `random_page_cost` ë‚®ì¶”ê¸°
- `effective_cache_size` ì‹¤ì œ ë©”ëª¨ë¦¬ì— ë§žê²Œ ì¡°ì •

**ê²€ì¦ ë°©ë²•:**
- `EXPLAIN (ANALYZE)`ë¡œ ì˜ˆìƒ vs ì‹¤ì œ ë¹„êµ
- CostëŠ” ìƒëŒ€ê°’ì¼ ë¿, **ì‹¤ì œ ì‹œê°„(EXPLAIN ANALYZE)ì´ ì§„ì‹¤**


## 2) ë„êµ¬ í™œìš©

### pg_stat_statements
**ìš©ë„**: ìƒìœ„ ëŠë¦°/ë¹ˆë²ˆ ì¿¼ë¦¬ ì‹ë³„

```sql
SELECT query, calls, total_time, mean_time
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 20;
```

**í™œìš©**: ì–´ë–¤ ì¿¼ë¦¬ê°€ ì „ì²´ ì‹œê°„ì„ ë§Žì´ ì“°ëŠ”ì§€ íŒŒì•…

### auto_explain
**ìš©ë„**: ëŠë¦° ì¿¼ë¦¬ ìžë™ ì‹¤í–‰ê³„íš ë¡œê¹…

```sql
-- postgresql.conf ì„¤ì •
shared_preload_libraries = 'pg_stat_statements,auto_explain'
auto_explain.log_min_duration = '200ms'  -- 200ms ì´ìƒ ì¿¼ë¦¬ë§Œ ë¡œê¹…
auto_explain.log_analyze = on
auto_explain.log_buffers = on
```

**í™œìš©**: ìš´ì˜ í™˜ê²½ì—ì„œ ëŠë¦° ì¿¼ë¦¬ ìžë™ ê°ì§€

### ì‹œê°í™” ë„êµ¬
- **EXPLAIN.depesz.com**: ì‹¤í–‰ê³„íšì„ ì›¹ì—ì„œ ì‹œê°í™”
- **Dalibo PEV**: PostgreSQL Explain Visualizer
- ë³µìž¡í•œ ì‹¤í–‰ê³„íšì„ íŠ¸ë¦¬ í˜•íƒœë¡œ ë³´ê¸° ì‰½ê²Œ í‘œì‹œ


## 3) ë§ˆë¬´ë¦¬: ë£¨í‹´í™” íŒ

### ì„±ëŠ¥ ê°œì„  í”„ë¡œì„¸ìŠ¤

1. **í›„ë³´ ì°¾ê¸°**: `pg_stat_statements`ë¡œ ëŠë¦° ì¿¼ë¦¬ ì‹ë³„
2. **ë³‘ëª© í™•ì¸**: `EXPLAIN (ANALYZE, BUFFERS)`ë¡œ ë³‘ëª© ë…¸ë“œ ì°¾ê¸°
3. **ê°œì„  ì‹¤í–‰**: ì¸ë±ìŠ¤ â†’ ì¿¼ë¦¬ ìˆ˜ì • â†’ í†µê³„ ê°±ì‹  ìˆœìœ¼ë¡œ ì‹œë„
4. **ê²°ê³¼ ê¸°ë¡**: ì „/í›„ ìˆ˜ì¹˜(ì‹œê°„, Buffers, Rows) ë¹„êµ ë° ê³µìœ 

---

> **ì´ì „**: [2ë¶€: ì‹¤ì „ ìµœì í™”](/blog/posts/dev/storage/postgres_explain_optimization/)  
> **ì‹œë¦¬ì¦ˆ ì‹œìž‘**: [1ë¶€: ê¸°ë³¸ê¸°](/blog/posts/dev/storage/postgres_explain_basics/)

