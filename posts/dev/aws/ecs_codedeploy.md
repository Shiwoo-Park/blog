---
layout: post
title: "AWS - ECS 로 Code Deploy 를 이용해 배포하기"
date: 2024-07-18
categories: [aws, ecs, codedeploy]
---
Code Deploy 를 이용해 ECS 로 배포하기 위한 삽질들을 기록하였습니다.

## 삽질 1 - CPU 아키텍쳐 호환성 문제

- 내가 쓰는 컴퓨터는 맥북인데 (arm64) 내가 배포하려는 환경은 linux x86 뿐임.
- 그래서 로컬에서 프로젝트를 빌드하여 ECR 에 이미지를 올리면(ARM64) 서버에서 이미지 구동할때(x86) 커맨드 실행 에러남.
- ECS - Fargate Spot instance 는 arm64를 지원하지 않음 (현재시점 기준)
- 즉 코드를 빌드하는 서버의 CPU 아키텍쳐가 배포 후 서비스가 구동될 서버 CPU 와 동일해야한다는 뜻.

## 삽질 2 - Code Deploy 그리고 블루/그린 배포

- Code Deploy 는 블루/그린 배포 밖에 지원하지 않음.
  - ECS 에서 서비스 만들때 간단한 배포이니 롤링 업데이트하면 되지 않을까 싶어서 그 배포 방식으로 서비스를 생성했었는데... 
  - 결국 변경도 불가능해서 아예 지우고 다시 만듦..
- 블루/그린 배포는 무조건 2개 이상의 EC2 대상그룹을 지정해줘야함.
  - 2개의 대상그룹이 운용되는 상황에서 자연스럽게 트래픽을 넘겨야 하니까 당연..
- [중요!!] 블루/그린 배포용으로 사용될 임시 대상그룹은 로드밸런서에서 세팅하지 않는다 당장 트래픽을 받고있어서는 안됨.
  - 즉, 로드밸런서와 상관없이 그냥 독립적으로 생성해둔다.
- 서비스 배포 시 Code Deploy 용으로 활용할 2개의 대상그룹을 지정하는 부분
  - ECS 태스크 정의 시, 배포 세팅하는 부분
  - Code Deploy - ECS 어플리케이션 - 배포 그룹 최초 생성할때 로드밸런서 부분

## 삽질 3 - 젠킨스에서 Code Deploy 로 파라미터 넘기기

- Code Deploy 는 appspec.yml 파일 기반으로 코드를 배포함.
- jenkins 에서 아래의 과정들을 거치게 됨
  - Repository 로부터 배포할 코드 버전을 다운로드
  - 배포 환경별로 필요한 작업들 처리 (환경변수 파일 재배치, 코드빌드 등)
  - 도커 이미지 빌드 및 태깅 (unique tag, latest tag)
  - ECR 에 이미지 업로드
